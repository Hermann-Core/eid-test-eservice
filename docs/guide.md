# eService Test Implementation Guide (SOAP, No Signatures)

## 1. Introduction

This guide describes how to implement a minimal **eService** to test the authentication flow between an **eID-Client** and an **eID-Server** using **SOAP interfaces only**. XML Signature verification and generation are **explicitly omitted for now**, but placeholders are shown where they would normally apply.

The eService acts as:
- A **Web Application** providing an entry point for the user.
- A **TC Token Provider** responding to `tcTokenURL` requests from the eID-Client.
- A **SOAP Client** communicating with the eID-Server via `useID` and `getResult`.

---

## 2. High-Level Flow

1. User clicks **“Use eID”** on eService.
2. Browser redirects eID-Client with `tcTokenURL`.
3. eID-Client fetches the **TC Token** from eService.
4. Before sending TC Token, eService calls **`useID`** on eID-Server.
5. eService returns TC Token with:
   - `ServerAddress` from eID-Server.
   - `SessionIdentifier` (generated by eService).
   - `PSK` from eID-Server inside `PathSecurity-Parameters`.
6. eID-Client talks to eID-Server directly via TLS-PSK.
7. eID-Client returns user to eService’s **RefreshAddress**.
8. eService calls **`getResult`** to fetch final authentication data.

---

## 3. Specification & Example Combined (Hybrid Format)

### 3.1 Browser Entry Point

**Requirement (Spec):**
The eService must provide a link/object that forwards a `tcTokenURL` to the eID-Client.

**Example (HTML):**
```html
<object type="application/vnd.eid-client"
        data="https://service.example.de/tctoken?ABC123">
  <a href="http://127.0.0.1:24727/eID-Client?tcTokenURL=https%3A%2F%2Fservice.example.de%2Ftctoken%3FABC123">
    Start eID Authentication
  </a>
</object>
```

---

### 3.2 SOAP `useID` Request

**Requirement (Spec):**
The eService must request a session and PSK from the eID-Server before issuing a TC Token.

**Example SOAP Request:**
```xml
<soapenv:Envelope xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/"
                  xmlns:eid="http://bsi.bund.de/eID/">
  <soapenv:Header/>
  <soapenv:Body>
    <eid:useIDRequest>
      <eid:UseOperations/>
    </eid:useIDRequest>
  </soapenv:Body>
</soapenv:Envelope>
```

**Example SOAP Response (from eID-Server):**
```xml
<eid:useIDResponse xmlns:eid="http://bsi.bund.de/eID/">
  <eid:Session>
    <eid:ID>ABCDEF1234567890</eid:ID>
  </eid:Session>
  <eid:PSK>
    <eid:ID>SESSIONID1234</eid:ID>
    <eid:Key>FEDCBA0987654321</eid:Key>
  </eid:PSK>
</eid:useIDResponse>
```

---

### 3.3 TC Token Response

**Requirement (Spec):**
Return XML **without header**, ordered elements exactly as defined.

**Example Response to eID-Client:**
```xml
<tcToken>
  <ServerAddress>https://eid-server.example.de/eIDService</ServerAddress>
  <SessionIdentifier>SESSIONID1234</SessionIdentifier>
  <RefreshAddress>https://service.example.de/refresh?token=XYZ</RefreshAddress>
  <Binding>urn:liberty:paos:2006-08</Binding>
  <PathSecurity-Protocol>urn:ietf:rfc:4279</PathSecurity-Protocol>
  <PathSecurity-Parameters>
    <PSK>FEDCBA0987654321</PSK>
  </PathSecurity-Parameters>
</tcToken>
```

---

### 3.4 SOAP `getResult`

**Example Request:**
```xml
<soapenv:Envelope xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/"
                  xmlns:eid="http://bsi.bund.de/eID/">
  <soapenv:Body>
    <eid:getResultRequest>
      <eid:Session>
        <eid:ID>ABCDEF1234567890</eid:ID>
      </eid:Session>
    </eid:getResultRequest>
  </soapenv:Body>
</soapenv:Envelope>
```

**Example Response:**
```xml
<eid:getResultResponse>
  <eid:Result>OK</eid:Result>
  <eid:PersonalData>
    <eid:FamilyName>Doe</eid:FamilyName>
    <eid:GivenNames>John</eid:GivenNames>
  </eid:PersonalData>
</eid:getResultResponse>
```

---

## 4. Next Steps

Signature and certificate validation placeholders should be inserted at:

- Incoming `useIDResponse` (verify server signature).
- Incoming `getResultResponse`.

These will be implemented later.

---

**End of Document**
